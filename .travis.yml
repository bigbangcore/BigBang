# Please refer to https://docs.travis-ci.com/
language: cpp

sudo: required

dist: bionic # ubuntu 18.04

compiler:
- gcc
- clang

os:
- linux
- osx

branches:
  only:
  - master
  - mkf-master

matrix:
  exclude:
    # Use clang in osx, and gcc in linux
    - compiler: gcc
      os: osx
    - compiler: clang
      os: linux

env:
  global:
    - CACHE_DIR1=$([ $TRAVIS_OS_NAME = 'osx' ] && echo "$HOME/Library/Caches/Homebrew" || echo "$HOME/apt")
    - CACHE_DIR1=$([ $TRAVIS_OS_NAME = 'osx' ] && echo "/usr/local/Homebrew" || echo "/usr/local/apt")

cache:
  directories:
    - $CACHE_DIR1
    - $CACHE_DIR2

before_cache:
  - if [ "${TRAVIS_OS_NAME}" = "osx" ]; then brew cleanup; fi
  - if [ "${TRAVIS_OS_NAME}" = "osx" ]; then find /usr/local/Homebrew \! -regex ".+\.git.+" -delete; fi

install:
- if [ "$TRAVIS_OS_NAME" == "osx" ]; then
    brew update;
    brew install cmake pkg-config openssl boost libsodium readline protobuf ncurses;
    export OPENSSL_ROOT_DIR=`brew --prefix openssl`;
    git clone https://github.com/eclipse/paho.mqtt.c.git;
    cd paho.mqtt.c;
    git checkout v1.3.1;
    mkdir build && cd build;
    cmake -DPAHO_BUILD_STATIC=TRUE -DPAHO_WITH_SSL=TRUE ..;
    sudo make install;
    sudo mkdir /usr/local/include/mqtt/;
    sudo chmod 755 /usr/local/include/mqtt/;
    sudo cp ${TRAVIS_BUILD_DIR}/src/mqtt/src/mqtt/* /usr/local/include/mqtt/;
    sudo chmod 644 /usr/local/include/mqtt/*;
    cd ../;
  else
    sudo apt-get update -qq;
    sudo apt install -y g++ cmake libboost-all-dev openssl libssl1.0-dev libreadline-dev pkg-config libprotobuf-dev protobuf-compiler libncurses5-dev autoconf;
    sudo apt install -y cppcheck valgrind clang-format-8;
    wget https://github.com/jedisct1/libsodium/releases/download/1.0.18-RELEASE/libsodium-1.0.18.tar.gz;
    tar -zxvf libsodium-1.0.18.tar.gz;
    cd libsodium-1.0.18;
    ./autogen;
    ./configure;
    make -j2;
    sudo make install;
    cd ../;
    git clone https://github.com/eclipse/paho.mqtt.c.git;
    cd paho.mqtt.c;
    git checkout v1.3.1;
    mkdir build && cd build;
    cmake -DPAHO_BUILD_STATIC=TRUE -DPAHO_WITH_SSL=TRUE ..;
    sudo make install;
    sudo cp -r  ${TRAVIS_BUILD_DIR}/src/mqtt/src/mqtt/ /usr/local/include/;
    sudo chmod 755 /usr/local/include/mqtt;
    cd /usr/local/include/mqtt;
    sudo chmod 644 *;
    cd -;
    cd ../..;
  fi

before_script:
- ulimit -c unlimited -S       # enable core dumps

script:
- ./INSTALL.sh
- ./build/test/test_big
- ./build/test/test_ctsdb
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then
    cppcheck -j2 --error-exitcode=1 --std=c++11 --enable=warning,performance,portability -i libsodium-1.0.18 -i src/leveldb -i build -i src/snappy -i src/crypto -i src/jsonrpc/json -i src/xengine/docker -i script -i test -i paho.mqtt.c -i src/mqtt . ;
  fi
